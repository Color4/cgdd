{% extends 'gendep/base.html' %}
{% block links %}
{# Links to jQuery and jQuery-UI google hosted libraries for the autocomplete search box: #}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
// Using a preloaded array gives faster response than AJAX call.
// The 'label' needs to contain the gene_name as it is the label that is searched for the characters pressed. Maybe add a separate description field.
var driver_array = [
   {% for driver in driver_list %} {value: "{{driver.gene_name}}", label: "{{driver.full_name}} : {{driver.gene_name}}|{{driver.prev_names}}{% if driver.prev_names != '' %}|{% endif %}{{driver.synonyms}}"},
   {% endfor %}
];

$(function() {
  $("#driver").autocomplete({
    // source: "/api/get_drivers/",   // to use Ajax call.
    source: driver_array,  // using the above array.
	// It is possible to format the list items using the focus and select functions and html, etc:	
    minLength: 0,  // number of letters need to type for drop-down menu to appear.
	delay: 1,  // 1 millisecond delay.
	autoFocus: true,
  }).autocomplete( "instance" )._renderItem = function( ul, item ) {
        return $( "<li>" )
            .append( "<a><b>" + item.value+ "</b> - " + item.label+ "</a>" )
            .appendTo( ul );
    };
});

function is_form_valid() {
  // As the autocomplete form permits text that doesn't match any driver:
  var d = document.getElementById("driver").value;
  if (d == null || d == "") {
    alert("Driver gene field needs a value entered");
    return false;
    }
  
  var found = false;
  var i;
  for (i=0; i<driver_array.length; i++) {
	if (d == driver_array[i]['value']) {
	   found = true;
	   break;
	   }
	}
  if (found == false) {alert("Driver gene value: '"+d+"' doesn't match any drivers in the list. Please select a driver gene.");}
  return found;
  }; 
</script>
{% endblock %}
{% block content %}
<p> &nbsp; </p>

<form action="{% url 'gendep:results' %}" onsubmit="return is_form_valid();" method="post">
{% csrf_token %}
   
<table align="center" cellpadding="2" style="background-color: #ddddff; border: 1px solid blue;">
<tr><td colspan="2" style="text-align: center;">Specify your search filter</td></tr>

<tr><td>
  <label for="driver">Driver gene: </label>
</td> <td>
<!-- div class="ui-widget" -->
  <input name="driver" id="driver" required>
<!-- /div -->
</td></tr>

{% comment %}
<!-- Old menu which can remove later if the above ui-autocomplete keeps working -->
<tr><td>Driver gene:</td>
<td>
   <select name="driver" id="driver">
      <option value="" selected="selected"></option>
   {% for driver in driver_list %}
      <option value="{{driver.gene_name}}">{{driver.gene_name}} {{driver.full_name}} {{driver.synonyms}} {{driver.prev_names}}</option>
   {% endfor %}
   </select>
</td></tr>
{% endcomment %}   

<tr><td>Tissue type:</td>
<td>
   <select name="histotype" id="histotype">
      <option value="ALL_HISTOTYPES">All histotypes</option>
	{% for histotype in histotype_list %}
	{% comment %}
      <option value="{{ histotype.histotype }}" {% if histotype.histotype == "PANCAN" %} selected="selected" {% endif %}>{{ histotype.full_name }}</option>
	{% endcomment %}  
	  <option value="{{ histotype.0 }}" {% if histotype.0 == "PANCAN" %} selected="selected" {% endif %}>{{ histotype.1 }}</option>  
	{% endfor %}
   </select>
   
</td></tr>

<tr><td>Study:</td>
<td>
   <select name="study" id="study">
      <option value="ALL_STUDIES" selected="selected">All studies</option>
	{% for study in study_list %}
	  <option value="{{ study.pmid }}">{{ study.pmid }} {{ study.title}}</option>
	{% endfor %}
   </select>
</td></tr>
<tr><td colspan="2" align="center">
   <input type="submit" value="Search" />
</td></tr>

</table>
</form>
{% endblock %}
